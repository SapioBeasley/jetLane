<html>
    <head>
        <script
            type="text/javascript"
            src="../../../../js/jquery-1.4.2.min.js">
        </script>
        <script
            type="text/javascript"
            src="../../../../syntax_highlighter/scripts/shCore.js">
        </script>
        <script
            type="text/javascript"
            src="../../../../syntax_highlighter/scripts/shBrushJScript.js">
        </script>
        <script
            type="text/javascript"
            src="../../../../syntax_highlighter/scripts/shBrushPhp.js">
        </script>
        <script
            type="text/javascript"
            src="../../../../syntax_highlighter/scripts/shBrushXml.js">
        </script>
        <link
            href="../../../../syntax_highlighter/styles/shCore.css" rel="stylesheet"
            type="text/css"
        />
        <link
            href="../../../../syntax_highlighter/styles/shCoreEclipse.css"
            rel="stylesheet" type="text/css"
        />
        <link
            href="../../../../syntax_highlighter/styles/shThemeWordpress.css"
            rel="stylesheet" type="text/css"
        />
    </head>
    <body>
        <pre class="brush: php">&lt;?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use Sapioweb\CrudHelper\CrudyController as CrudHelper;
use App\Http\Requests;
use App\Http\Controllers\Controller;
use App\PeopleContact;
use App\CompanyContact;

class ContactsController extends Controller
{
	protected $role;

	/**
	* Create a new controller instance.
	*
	* @return void
	*/
	public function __construct()
	{
		// Instanciate the middleware auth
		$this-&gt;middleware('auth');

		// installs global error and exception handlers
		\Rollbar::init(array('access_token' =&gt; env('ROLLBAR_ACCESS_TOKEN')));

		// Check if user is logged in
		if (\Auth::check()) {

			// if user is logged in, run the 'getUsersRole' method
			$this-&gt;role = $this-&gt;getUsersRole(\Auth::user()-&gt;id);
		}
	}

	/**
	 * Grab a logged in users role and who they are
	 * @param  int          $userId     the id of the logged in user
	 * @return   array                        return the role id, the actual ame of the role, and the users id
	 */
	public function getUsersRole($userId)
	{
		$user = CrudHelper::show(new \App\User, 'id', $userId, ['roles']);

		$role= $user['roles']-&gt;first();

		$role = [
			'id' =&gt; $role-&gt;id,
			'role' =&gt; $role-&gt;role,
			'userId' =&gt; $user-&gt;id
		];

		return $role;
	}

	public function indexCompany()
	{
		$contacts = $this-&gt;getContactsByRole(new \App\CompanyContact);

		return view('contact.companies.index')-&gt;with([
			'contacts' =&gt; $contacts
		]);
	}

	public function indexPeople()
	{
		$contacts = $this-&gt;getContactsByRole(new \App\PeopleContact);

		return view('contact.people.index')-&gt;with([
			'contacts' =&gt; $contacts
		]);
	}

	public function getContactsByRole($model)
	{
		switch (true) {
			case $this-&gt;role['role'] === 'admin':
				$contacts = $this-&gt;getAll($model);
				break;

			default:
				$contacts = $model-&gt;whereHas('createdBy', function ($query) {
   					$query-&gt;where('user_id', '=', $this-&gt;role['userId']);
				})-&gt;get();
				break;
		}

		return $contacts;
	}

	public function getAll($model)
	{
		$contacts = CrudHelper::index($model)-&gt;get();

		return $contacts;
	}

	public function showCompany($id)
	{
		$contact = $this-&gt;showContact(new \App\CompanyContact, $id, ['category']);

		return view('contact.companies.show')-&gt;with([
			'contact' =&gt; $contact
		]);
	}

	public function showPeople($id)
	{
		$contact = $this-&gt;showContact(new \App\PeopleContact, $id, ['category', 'companies']);

		return view('contact.people.show')-&gt;with([
			'contact' =&gt; $contact
		]);
	}

	public function showContact($model, $contactId, $relationships = [])
	{
		$contact = CrudHelper::show($model, 'id', $contactId, $relationships);

		if ($contact == null) {
			abort(404);
		}

		return $contact;
	}

	public function createCompany()
	{
		$companyCategories = $this-&gt;getCategories(new \App\CompanyCategory);

		return view('contact.companies.create')-&gt;with([
			'companyCategories' =&gt; $companyCategories
		]);
	}

	public function createPeople()
	{
		$peopleCategories = $this-&gt;getCategories(new \App\PeopleCategory);
		$companiesSelect = $this-&gt;companiesSelect();

		return view('contact.people.create')-&gt;with([
			'companiesSelect' =&gt; $companiesSelect,
			'peopleCategories' =&gt; $peopleCategories
		]);
	}

	public function companiesSelect()
    	{
    		$companies = CrudHelper::index(new \App\CompanyContact)-&gt;get();

    		foreach ($companies as $companyKey =&gt; $companyValue) {
    			$companiesSelect[$companyValue['id']] = $companyValue['name'];
    		}

    		$companiesSelect[0] = 'Select Company';

    		return $companiesSelect;
    	}

    	public function getCategories($model)
    	{
    		$categories = CrudHelper::index($model)-&gt;get();

    		return $categories;
    	}

    	public function storeCompany(Request $request)
	{
		$contact = $this-&gt;createContact(new \App\CompanyContact, $request-&gt;all());

		$data = $request-&gt;all();

		if (! is_null($data['category'])) {
			$categoryIds = $this-&gt;updateCategories(new \App\CompanyCategory, $data['category']);

			$contact-&gt;category()-&gt;sync($categoryIds);
		}

		$this-&gt;createdBy($contact);

		return redirect()-&gt;route('contact.company.show', $contact-&gt;id)-&gt;with([
			'success_message' =&gt; 'Conact Successfully created...'
		]);
	}

	public function storePeople(Request $request)
	{
		$contact = $this-&gt;createContact(new \App\PeopleContact, $request-&gt;all());

		$data = $request-&gt;all();

		if (! is_null($data['category'])) {
			$categoryIds = $this-&gt;updateCategories(new \App\PeopleCategory, $data['category']);

			$contact-&gt;category()-&gt;sync($categoryIds);
		}

		if ($data['company'] !== '0') {
			$contact = PeopleContact::find($contact['id']);

			$contact-&gt;companies()-&gt;attach($data['company']);

			$contact-&gt;save();
		}

		$this-&gt;createdBy($contact);

		return redirect()-&gt;route('contact.people.show', $contact-&gt;id)-&gt;with([
			'success_message' =&gt; 'Conact Successfully created...'
		]);
	}

	public function createdBy($createdContact)
	{
		$createdContact-&gt;createdBy()-&gt;sync([(string) $this-&gt;role['userId']]);

		return null;
	}

	public function createContact($model, $data)
	{
		if ($data['avatar']) {
			$avatarUpload = $this-&gt;avatarUpload($data['avatar']);

			$data['avatar'] = $avatarUpload;
		}

		$contact = CrudHelper::store($model, $data);

		return $contact;
	}

	public function editCompany($id)
	{
		$contact = $this-&gt;showContact(new \App\CompanyContact, $id, ['category']);

		if (! empty($contact['category'])) {
			$selectedCategories = $contact['category'];
		}

		$companyCategories = $this-&gt;unsetSelectedCategory(new \App\CompanyCategory, $selectedCategories);

		return view('contact.companies.edit')-&gt;with([
			'contact' =&gt; $contact,
			'companyCategories' =&gt; $companyCategories,
			'selectedCategories' =&gt; $selectedCategories
		]);
	}

	public function editPeople($id)
	{
		$contact = $this-&gt;showContact(new \App\PeopleContact, $id, ['category', 'companies']);

		if (! empty($contact['category'])) {
			$selectedCategories = $contact['category'];
		}

		$peopleCategories = $this-&gt;unsetSelectedCategory(new \App\PeopleCategory, $selectedCategories);

		if (isset($contact['companies']) &amp;&amp; ! empty($contact['companies'])) {
			$contactCompanies = $contact['companies'][0]['id'];
		}

		$companiesSelect = $this-&gt;companiesSelect();

		return view('contact.people.edit')-&gt;with([
			'contact' =&gt; $contact,
			'companiesSelect' =&gt; $companiesSelect,
			'contactCompanies' =&gt; $contactCompanies,
			'peopleCategories' =&gt; $peopleCategories,
			'selectedCategories' =&gt; $selectedCategories
		]);
	}

	public function unsetSelectedCategory($model, $selectedCategories)
	{
		$allCategories = $this-&gt;getCategories($model);

		foreach ($selectedCategories as $selectedCategory) {
			foreach ($allCategories as $categoryKey =&gt; $category) {

				if ($selectedCategory['category'] === $category['category']) {
					unset($allCategories[$categoryKey]);
				}

			}
		}

		return $allCategories;
	}

	public function deleteCompany(Request $request, $id)
	{
		$contact = $this-&gt;destroyContact(new \App\CompanyContact, $id);

		return redirect()-&gt;route('contact.company.index')-&gt;with([
			'success_message' =&gt; 'Contact has been deleted...'
		]);
	}

	public function deletePeople(Request $request, $id)
	{
		$contact = $this-&gt;destroyContact(new \App\PeopleContact, $id);

		return redirect()-&gt;route('contact.people.index')-&gt;with([
			'success_message' =&gt; 'Contact has been deleted...'
		]);
	}

	public function destroyContact($model, $id)
	{
		$contact = CrudHelper::destroy($model, $id);

		return $contact;
	}

	public function updateCompany(Request $request, $id)
	{
		$contact = CrudHelper::show(new \App\CompanyContact, 'id', $id);

		foreach ($request-&gt;all() as $updateField =&gt; $updateValue) {
			$updateContact[$updateField] = $updateValue;
		}

		if (! is_null($updateContact['category'])) {
			$categoryIds = $this-&gt;updateCategories(new \App\CompanyCategory, $updateContact['category']);

			$contact-&gt;category()-&gt;sync($categoryIds);
		}

		$contact-&gt;update($updateContact);

		return redirect()-&gt;back()-&gt;with([
			'success_message' =&gt; 'Contact has been updated...'
		]);
	}

    	public function updatePeople(Request $request, $id)
    	{
    		if ($request-&gt;hasFile('avatar')) {
			$avatarUpload = $this-&gt;avatarUpload($request-&gt;file('avatar'));

			$updateContact['avatar'] = $avatarUpload;
		}

    		$contact = CrudHelper::show(new \App\PeopleContact, 'id', $id);

    		foreach ($request-&gt;all() as $updateField =&gt; $updateValue) {
    			$updateContact[$updateField] = $updateValue;
    		}

    		if (! is_null($updateContact['category'])) {

			$categoryIds = $this-&gt;updateCategories(new \App\PeopleCategory, $updateContact['category']);

			$contact-&gt;category()-&gt;sync($categoryIds);
		}

    		if ($updateContact['company'] !== '0') {

			$contactComapany = PeopleContact::find($contact['id']);

			$contactComapany-&gt;companies()-&gt;sync([$updateContact['company']]);
		}

    		$contact-&gt;update($updateContact);

    		return redirect()-&gt;back()-&gt;with([
    			'success_message' =&gt; 'Contact has been updated...'
    		]);
    	}

    	public function updateCategories($catModel, $data)
    	{
    		foreach ($data as $categoryKey =&gt; $categoryValue) {
			$categories[] = $categoryKey;
		}

		foreach ($categories as $category) {
			$findCategory = CrudHelper::show($catModel, 'category', $category);

			$categoryId[] = $findCategory['id'];
		}

		return $categoryId;
    	}

    	public function avatarUpload($upload)
    	{
    		$destinationPath = 'images/avatars/';

    		$fileName = 'avatar_' . crc32($upload-&gt;getClientOriginalName()) . '.' . $upload-&gt;getClientOriginalExtension();

    		$upload-&gt;move($destinationPath, $fileName);

    		$avatar = url('/') . '/' . $destinationPath . $fileName;

    		return $avatar;
    	}
}
</pre>
        <script type="text/javascript">
             SyntaxHighlighter.all();
             jQuery('.gutter div').each(function(key, data){
                jQuery(data).prepend('<a name="L'+jQuery(data).text()+'"/>');
             });
        </script>
    </body>
</html>